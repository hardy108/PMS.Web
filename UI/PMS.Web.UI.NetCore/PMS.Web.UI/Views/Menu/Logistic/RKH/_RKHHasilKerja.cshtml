@using PMS.Web.UI.Code
@{

    string tblId = "tblRkhHerbisida";
    string tblDetailId = "tblRkhDetail";
    string isReadOnlyString = GeneralHelpers.BooleanStringHtml(ViewBag.ReadOnly);

}
<x-form-row>
    <x-form-col xs-size="12" id="frmHasilKerja">
        <x-form-row>
            <x-field-number id="PRODKG" caption="Produksi (Kg)" xs-size="12" md-size="2" read-only="@ViewBag.ReadOnly" binding-field="PRODKG"></x-field-number>
            <x-field-number id="BRONDOLKG" caption="Brondolan (Kg)" xs-size="12" md-size="2" read-only="@ViewBag.ReadOnly" binding-field="BRONDOLKG"></x-field-number>
            <x-field-number id="BRONDOLPCT" caption="Brondolan (%)" xs-size="12" md-size="2" read-only="true" binding-field="BRONDOLPCT"></x-field-number>
            <x-field-number id="PANENTK" caption="TK Panen (Orang)" xs-size="12" md-size="2" read-only="@ViewBag.ReadOnly" binding-field="PANENTK"></x-field-number>
            <x-field-number id="OUTPUTPANEN" caption="Output Pemanen (Kg/T)" xs-size="12" md-size="2" read-only="true" binding-field="OUTPUTPANEN"></x-field-number>
        </x-form-row>

        <x-form-row>
            <x-field-number id="PUPUKKG" caption="Pupuk (Kg)" xs-size="12" md-size="2" read-only="@ViewBag.ReadOnly" binding-field="PUPUKKG"></x-field-number>
            <x-field-number id="PUPUKTK" caption="TK Pupuk (Orang)" xs-size="12" md-size="2" read-only="@ViewBag.ReadOnly" binding-field="PUPUKTK"></x-field-number>
            <x-field-number id="OUTPUTPUPUK" caption="Output Pemupuk (Kg/TK)" xs-size="12" md-size="2" read-only="true" binding-field="OUTPUTPUPUK"></x-field-number>
            <x-field-number id="SEMPROTTK" caption="TK Semprot (Orang)" xs-size="12" md-size="2" read-only="@ViewBag.ReadOnly" binding-field="SEMPROTTK"></x-field-number>
            <x-field-number id="OUTPUTSEMPROT" caption="Output Penyemprot (Ha/TK)" xs-size="12" md-size="2" read-only="@ViewBag.ReadOnly" binding-field="OUTPUTSEMPROT"></x-field-number>
        </x-form-row>
    </x-form-col>
</x-form-row>
<x-form-row>
    <x-form-col xs-size="12">
        <div class="panel panel-default">
            <div class="panel-heading">Herbisida</div>
            <div class="panel-body">
                <table id="@(tblId)" class="table table-bordered table-hover" data-paging="true" data-sorting="true"></table>

                @if (!(ViewBag.ReadOnly))
                {
                    <x-form-row>
                        <x-form-col xs-size="12">
                            <button id="btnPilihHerbisida" class="btn btn-primary pull-left" onclick="@(tblId)_Handlers.showForm()">
                                Tambah
                            </button>
                            &nbsp;&nbsp;
                            <button id="btnHapusHerbisida" class="btn" onclick="@(tblId)_Handlers.deleteRows()">
                                Hapus
                            </button>
                        </x-form-col>
                    </x-form-row>
                }
            </div>
        </div>
    </x-form-col>
</x-form-row>    


    @if (!(ViewBag.ReadOnly))
    {


        <x-modal id="mdlHerbisida" caption="Pilih Material Herbisida">
            <x-modal-body>
                <x-form-row>
                    <x-field-data-list-material id="HERBISIDAID" binding-field="MATID" caption="Material Herbisida" multiple="true" xs-size="12" value-field="*">
                    </x-field-data-list-material>
                </x-form-row>
                <x-form-row>
                    <x-field-number id="HERBISIDAQTY" binding-field="QTY" caption="Qty" xs-size="12" md-size="4"></x-field-number>
                </x-form-row>
            </x-modal-body>
            <x-modal-footer>
                <x-form-row>
                    <x-form-col xs-size="12">
                        <button id="btnResetHerbisida" class="btn" onclick="resetElements('mdlHerbisida')">
                            Reset
                        </button>
                        &nbsp;&nbsp;
                        <button id="btnAddHerbisida" class="btn btn-primary" onclick="@(tblId)_Handlers.addRows()">
                            Tambah
                        </button>
                        &nbsp;&nbsp;
                        <button id="btnAddCloseHerbisida" class="btn btn-primary" onclick="@(tblId)_Handlers.addRows(true)">
                            Tambah dan Tutup
                        </button>
                        &nbsp;&nbsp;
                        <button id="btnCloseActivity" class="btn" onclick="$('#mdlHerbisida').modal('hide')">
                            Tutup
                        </button>
                    </x-form-col>
                </x-form-row>
            </x-modal-footer>
        </x-modal>
    }


    <script>
        $('#PRODKG').on('focusout', function () { @(tblId)_Handlers.calculate(); });
        $('#BRONDOLKG').on('focusout', function () { @(tblId)_Handlers.calculate(); });
        $('#PANENTK').on('focusout', function () { @(tblId)_Handlers.calculate(); });
        $('#PUPUKKG').on('focusout', function () { @(tblId)_Handlers.calculate(); });
        $('#PUPUKTK').on('focusout', function () { @(tblId)_Handlers.calculate(); });
    var @(tblId)_Handlers = {
        columns: [
            {
                "type": "html",
                "name": "CHKSELECT",
                "title": "<input type='checkbox' id='chkAllHerbisida' name='chkDeleteHerbisida' onclick='checkAllCheckBox(this)'>",
                "visible": !@(isReadOnlyString),
                "formatter": function (value,option,rowdata) {
                    return "<input type='checkbox' name='chkDeleteHerbisida'>";
                },
            },
            {
                "type": "text",
                "name": "key",
                "visible": false
            },
            {
                "type": "text",
                "name": "MATID",
                "title": "Kode Material",
                "visible": false
            },
            {
                "type": "text",
                "title": "Nama Material",
                "name": "MATNAME",
                "visible": true
            },
            {
                "type": "number",
                "title": "Qty",
                "name": "QTY",
                "visible": @(isReadOnlyString)
            },
            {
                "type": "html",
                "name": "QTY_INPUT",
                "title": "Qty",
                "formatter": function (value, option, rowdata) {
                    return "<input type='number' name='QTY' value='" + rowdata["QTY"] + "'  data-bf='QTY' onfocusout='updateInputToRow(this)'>";
                },
                "visible": !@(isReadOnlyString)
            },
            {
                "type": "text",
                "title": "UOM",
                "name": "UOM",
                "visible": true
            },
        ],

        initTable: function (rows) {
            if (isAny(rows)) {
                rows.forEach(function (row) {
                    row.MATNAME = dictMaterials[row.MATID].MATNAME
                    row.UOM = dictMaterials[row.MATID].UOM;
                });
            }
            $("#@(tblId)").footable({
                "columns": @(tblId)_Handlers.columns,
                "rows": rows
            });
        },
        rowKeys: ["MATID"],
        getRowKey: function (values) {
            if (values)
                return helper.footableRowKey(values, @(tblId)_Handlers.rowKeys);
            return null;
        },

        isRowExist: function (values, allrows) {
            return helper.footableRowExist(values, allrows,@(tblId)_Handlers.rowKeys);
        },
        selectedMaterials: [],

        addRows: function (closeForm) {
            @(tblId)_Handlers.selectedMaterials = $('#HERBISIDAID').flexdatalist('value');
            if (!@(tblId)_Handlers.selectedMaterials || @(tblId)_Handlers.selectedMaterials.length <= 0)
                return false;

            var ft = FooTable.get('#@(tblId)');
            if (!ft) {
                alert("invalid table");
                return;
            }

            var added = 0;
            var qty = $('#HERBISIDAQTY').val();

            @(tblId)_Handlers.selectedMaterials.forEach(function (material) {

                var detail = {
                        MATID: material.MATERIALID,
                        MATNAME: material.MATERIALID + " - " + material.MATERIALNAME,
                        UOM: material.UOM,
                        QTY: qty
                };

                detail.key = @(tblId)_Handlers.getRowKey(detail);
                if (!@(tblId)_Handlers.isRowExist(detail, ft.rows.all)) {
                    ft.rows.add(detail, false);
                    added++;
                }

            });



            if (added)
                ft.draw();

            if (closeForm)
                $('#mdlHerbisida').modal('hide');

        },
        deleteRows: function () {
            if (!confirm('Yakin akan menghapus detail herbisia?'))
                return;
            var ft = FooTable.get('#@(tblId)');
            var deletedCount = 0;
            if (ft) {

                $('[name = "chkDeleteHerbisida"]').each(function () {
                    if (this.id !== 'chkAllHerbisida') {
                        if (this.checked) {
                            var $row = FooTable.getRow($(this).closest('tr'));
                            $row.delete(false);
                            deletedCount++;
                        }

                    }
                });

                if (deletedCount)
                    ft.draw();
            }
        },

        saveRows : function () {
            var ft = FooTable.get('#@(tblId)');
            if (!ft) {
                alert("invalid table");
                return null;
            }

            var rows = [];
            $.each(ft.rows.all, function (i, row) {
                if (row.val()["QTY"] > 0)
                    rows.push(row.val());
            });
            return rows;
        },
        showForm: function () {
            $('#mdlHerbisida').modal('show');
            return true;
        },
        calculate: function () {
            if ($('#PRODKG').val() > 0 && $('#BRONDOLKG').val() > 0)
                $('#BRONDOLPCT').val($('#BRONDOLKG').val() * 100.00 / $('#PRODKG').val());
            else
                $('#BRONDOLPCT').val(0);
            if ($('#PANENTK').val() > 0 && $('#PRODKG').val() > 0)
                $('#OUTPUTPANEN').val($('#PRODKG').val() / $('#PANENTK').val());
            else
                $('#OUTPUTPANEN').val(0);
            if ($('#PUPUKKG').val() > 0 && $('#PUPUKTK').val() > 0)
                $('#OUTPUTPUPUK').val($('#PUPUKKG').val() / $('#PUPUKTK').val());
            else
                $('#OUTPUTPUPUK').val(0);


        }
    };

    </script>
