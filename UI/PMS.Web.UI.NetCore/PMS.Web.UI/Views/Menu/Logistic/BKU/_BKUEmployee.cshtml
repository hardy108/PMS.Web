@using PMS.Web.UI.Code
@{

    string tblEmployeeId = "tblBKUEmployee";
    string isReadOnlyString = GeneralHelpers.BooleanStringHtml(ViewBag.ReadOnly);

}

<x-form-row>
    <x-form-col xs-size="12">
        <table id="@(tblEmployeeId)" class="table table-bordered table-hover" data-paging="true" data-sorting="true"></table>
    </x-form-col>
</x-form-row>
@if (!(ViewBag.ReadOnly))
{
<x-form-row>
    <x-form-col xs-size="12">
        <button id="btnPilihEmployee" class="btn btn-primary pull-left" onclick="@(tblEmployeeId)_Handlers.showForm()">
            Tambah
        </button>
        &nbsp;&nbsp;
        <button id="btnHapusEmployee" class="btn" onclick="@(tblEmployeeId)_Handlers.deleteRows()">
            Hapus
        </button>
    </x-form-col>
</x-form-row>

<x-modal id="mdlEmployee" caption="Pilih Karyawan">
    <x-modal-body>
        <x-form-row>
            <x-field-data-list-employee id="EMPID" binding-field="EMPID" caption="Karyawan" multiple="true" xs-size="12" value-field="*" api-url-param="STATUS=A">
            </x-field-data-list-employee>
        </x-form-row>
        <x-form-row>
            <x-field-number id="VALUE" binding-field="VALUE" caption="HK" xs-size="12" md-size="4"></x-field-number>
        </x-form-row>
    </x-modal-body>
    <x-modal-footer>
        <x-form-row>
            <x-form-col xs-size="12">
                <button id="btnResetEmployee" class="btn" onclick="resetElements('mdlEmployee')">
                    Reset
                </button>
                &nbsp;&nbsp;
                <button id="btnAddEmployee" class="btn btn-primary" onclick="@(tblEmployeeId)_Handlers.addRows(true)">
                    Tambah
                </button>
                &nbsp;&nbsp;
                <button id="btnAddCloseEmployee" class="btn btn-primary" onclick="@(tblEmployeeId)_Handlers.addRows(true,true)">
                    Tambah dan Tutup
                </button>
                &nbsp;&nbsp;
                <button id="btnCloseEmployee" class="btn" onclick="$('#mdlEmployee').modal('hide')">
                    Tutup
                </button>
            </x-form-col>
        </x-form-row>
    </x-modal-footer>
</x-modal>
}




<script>
    var @(tblEmployeeId)_Handlers = {
        columns: [
            {
                "type": "html",
                "name": "CHKSELECT",
                "title": "<input type='checkbox' id='chkAllEmployee' name='chkDeleteEmployee' onclick='checkAllCheckBox(this)'>",
                "visible": !@(isReadOnlyString),
                "formatter": function (value,option,rowdata) {
                    return "<input type='checkbox' name='chkDeleteEmployee'>";
                },
            },
            {
                "type": "text",
                "name": "key",
                "visible": false
            },
            {
                "type": "text",
                "title": "ID",
                "name": "ID",
                "visible": false,
            },
            {
                "type": "text",
                "title": "EQUIPTIMESHEETID",
                "name": "EQUIPTIMESHEETID",
                "visible": false,
            },
            {
                "type": "text",
                "name": "EMPID",
                "title": "ID Karyawan",
                "visible": true
            },
            {
                "type": "text",
                "title": "Nama Karyawan",
                "name": "EMPNAME",
                "visible": true
            },
            {
                "type": "number",
                "title": "HK",
                "name": "VALUE",
                "visible": @(isReadOnlyString),
            },
            {
                "type": "html",
                "name": "VALUE_INPUT",
                "title": "HK",
                "formatter": function (value, option, rowdata) {
                    return "<input type='number' name='VALUE' value='" + rowdata["VALUE"] + "'  data-bf='VALUE' onfocusout='updateInputToRow(this)'>";
                },
                "visible": !@(isReadOnlyString),
            },

        ],

        initTable: function (rows) {
            if (isAny(rows)) {
                rows.forEach(function (row) {
                    row.ID = dictEmployees[row.EMPID].ID;
                    row.EQUIPTIMESHEETID = dictEmployees[row.EMPID].EQUIPTIMESHEETID;                    
                    row.EMPID = dictEmployees[row.EMPID].EMPID;
                    row.EMPNAME = dictEmployees[row.EMPID].EMP.EMPNAME;
    
                });
            }
            $("#@(tblEmployeeId)").footable({
                "columns": @(tblEmployeeId)_Handlers.columns,
                "rows": rows
            });
        },
        rowKeys: ["EMPID"],

        getRowKey: function (values) {
            if (values)
                return helper.footableRowKey(values, @(tblEmployeeId)_Handlers.rowKeys);
            return null;
        },

        isRowExist: function (values, allrows) {
            return helper.footableRowExist(values, allrows,@(tblEmployeeId)_Handlers.rowKeys);
        },
        //selectedActivities: [],
        //selectedMaterials: [],
        selectedEmployees: [],

        addRows: function (fromEmployee,closeForm) {
            var qty = 0;
            if (fromEmployee) {
                @(tblEmployeeId)_Handlers.selectedEmployees = $('#EMPID').flexdatalist('value');
                qty = $('#VALUE').val();
            }

            if (!@(tblEmployeeId)_Handlers.selectedEmployees || @(tblEmployeeId)_Handlers.selectedEmployees.length <= 0)
                return false;

            var ft = FooTable.get('#@(tblEmployeeId)');
            if (!ft) {
                alert("invalid table");
                return;
            }

            var added = 0;

            @(tblEmployeeId)_Handlers.selectedEmployees.forEach(function (employee) {
                var emp = {
                    EMPID: employee.EMPID,
                    EMPNAME: employee.EMPNAME,
                };
                dictEmployees[employee.EMPID] = emp;
                var detail = {
                            EMPID: employee.EMPID,
                            EMPNAME: employee.EMPNAME,
                            VALUE: qty
                    };

                    detail.key = @(tblEmployeeId)_Handlers.getRowKey(detail);
                    if (!@(tblEmployeeId)_Handlers.isRowExist(detail, ft.rows.all)) {
                        ft.rows.add(detail, false);
                        added++;
                    }

                });


            if (added)
                ft.draw();
            if (closeForm)
                $('#mdlEmployee').modal('hide');
        },
        showForm: function () {

            if (!$('#DIVID').flexdatalist('value')) {
                alert("Divisi belum dipilih");
                return false;
            }

            $('#mdlEmployee').modal('show');
            return true;
        },
        deleteRows: function (activities) {

            var ft = FooTable.get('#@(tblEmployeeId)');
            var deletedCount = 0;
            if (ft) {
                    if (!confirm('Yakin akan menghapus detail material?'))
                        return;
                    $('[name = "chkDeleteEmployee"]').each(function () {
                        if (this.id !== 'chkAllEmployee') {
                            if (this.checked) {
                                var $row = FooTable.getRow($(this).closest('tr'));
                                $row.delete(false);
                                deletedCount++;
                            }

                        }
                    });
                
                if (deletedCount)
                    ft.draw();
            }
        },

        saveRows : function () {
            var ft = FooTable.get('#@(tblEmployeeId)');
            if (!ft) {
                alert("invalid table");
                return null;
            }

            var rows = [];
            $.each(ft.rows.all, function (i, row) {
                if (row.val()["VALUE"] > 0)
                    rows.push(row.val());
            });
            return rows;
        },
    };
</script>